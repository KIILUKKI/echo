rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ROOMS
    match /rooms/{roomId} {
      allow read: if true;
      allow create, update, delete: if true;

      // MESSAGES
      match /messages/{msgId} {
        allow read: if true;

        // Create: basic validation - allows text-only, gif-only, or both
        allow create: if
          request.resource.data.name is string &&
          request.resource.data.name.size() > 0 &&
          request.resource.data.color is string &&
          request.resource.data.time is timestamp &&
          (
            // Either has text content
            (request.resource.data.keys().hasAll(['text']) && 
             request.resource.data.text is string && 
             request.resource.data.text.size() <= 4000) ||
            // Or has GIF content
            (request.resource.data.keys().hasAll(['gif']) && 
             request.resource.data.gif is string &&
             request.resource.data.gif.matches('^https://.*')) ||
            // Or has both
            (request.resource.data.keys().hasAll(['text', 'gif']) && 
             request.resource.data.text is string && 
             request.resource.data.text.size() <= 4000 &&
             request.resource.data.gif is string &&
             request.resource.data.gif.matches('^https://.*'))
          );

        // Update: only original author can update (works because request.resource exists on update)
        allow update: if
          request.resource.data.name == resource.data.name &&
          (
            (request.resource.data.text is string && request.resource.data.text.size() <= 4000) ||
            (request.resource.data.gif is string && request.resource.data.gif.matches('^https://.*'))
          );

        // Delete: because client performs batch deletes (no Auth), allow deletes.
        // NOTE: This allows deletion by any client. Secure with Auth when possible.
        allow delete: if true;
      }

      // seen subcollection
      match /messages/{msgId}/seen/{seenId} {
        allow read: if true;
        allow create: if true;
        // allow deletion of seen records (so /clear can remove them)
        allow delete: if true;
        allow update: if false;
      }

      // reactions subcollection
      match /messages/{msgId}/reactions/{userId} {
        allow read: if true;
        allow create: if 
          request.resource.data.name is string &&
          request.resource.data.emoji is string &&
          request.resource.data.time is timestamp;
        allow update: if 
          request.resource.data.name == resource.data.name &&
          request.resource.data.emoji is string;
        allow delete: if true;
      }

      // typing docs
      match /typing/{userName} {
        allow read: if true;
        allow create, update, delete: if true;
      }
    }

    // USERS
    match /users/{userId} {
      allow read: if true;
      allow create: if true;
      // allow update for lastSeen timestamp, color, password, and role
      allow update: if 
        // Allow updating lastSeen timestamp (for online status)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastSeen'])) ||
        // Allow updating color
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['color'])) ||
        // Allow updating passwordHash
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['passwordHash'])) ||
        // Allow updating role
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role'])) ||
        // Allow full update if keys are valid user fields
        (request.resource.data.keys().hasOnly(['passwordHash', 'created', 'color', 'lastSeen', 'role']));
      // allow delete so users can change their username (old doc is deleted, new one created)
      allow delete: if true;
    }
  }
}
